<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@500;600;700&display=swap" rel="stylesheet">

  <title>Mis Reservas · NovaPet</title>
  <link rel="stylesheet" href="/css/estilo.css" />

  <style>
    /* ===========================
       MODAL BONITO DE CONFIRMACIÓN
    ============================ */
    .modal-bg {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,.45);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 2000;
      backdrop-filter: blur(2px);
      opacity: 0;
      pointer-events: none;
      transition: .25s ease;
    }
    .modal-bg.show {
      opacity: 1;
      pointer-events: auto;
    }

    .modal-box {
      background: #fff;
      padding: 25px;
      width: 350px;
      border-radius: 18px;
      text-align: center;
      font-family: Poppins, sans-serif;
      animation: pop .25s ease;
    }

    @keyframes pop {
      0% { transform: scale(.85); opacity: 0; }
      100% { transform: scale(1); opacity: 1; }
    }

    .modal-btns {
      margin-top: 20px;
      display: flex;
      justify-content: space-around;
      gap: 1rem;
    }

    .btn-aceptar {
      background: #27ae60;
      color: white;
      padding: 10px 20px;
      border-radius: 8px;
      font-weight: 600;
      cursor: pointer;
      border: none;
    }

    .btn-cerrar {
      background: #bdc3c7;
      padding: 10px 20px;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
      border: none;
    }
  </style>
</head>

<body class="page-dashboard">

  <!-- HEADER -->
  <header class="dash-top">
    <div class="dash-top__inner">
      <a class="dash-brand" href="/dashboard">
        <img src="/img/logo.jpg" alt="NovaPet" />
      </a>
      <div class="user">
        <span class="user__hello">Hola,</span>
        <button class="user__btn" id="userMenuBtn">
          <%= userName %>
          <svg width="14" height="14"><path d="M5 7l5 6 5-6" fill="none" stroke="currentColor" stroke-width="2"/></svg>
        </button>
        <nav class="user__menu" id="userMenu">
          <a href="/perfil">Perfil</a>
          <a href="/logout">Cerrar sesión</a>
        </nav>
      </div>
    </div>
  </header>

  <!-- MAIN -->
  <main class="servicios">
    <h1 class="servicios__title">Mis Reservas y Citas</h1>

    <!-- Tabs -->
    <div class="reservas__tabs">
      <a href="?tipo=productos" class="user__btn <%= tipo==='productos'?'is-active':'' %>">Productos</a>
      <a href="?tipo=citas" class="user__btn <%= tipo==='citas'?'is-active':'' %>">Citas</a>
      <a href="?tipo=historial" class="user__btn <%= tipo==='historial'?'is-active':'' %>">Historial</a>
    </div>

    <!-- GRID -->
    <div class="reservas__grid">
      <% if (items && items.length > 0) { %>
        <% items.forEach(i => { %>
          <% let color = i.estado === 'vencida' ? '#f39c12' : i.estado === 'cancelada' ? '#c0392b' : '#27ae60'; %>

          <div class="reserva-card">

            <div class="servicio__media">
              <img src="<%= i.img %>" alt="<%= i.nombre %>">
            </div>

            <div class="servicio__body">
            <div class="estado-badge estado-<%= i.estado %>">
              <%= i.estado.toUpperCase() %>
            </div>


              <h3><%= i.nombre %></h3>
              <% if (i.precio) { %>
                <p>$<%= i.precio.toLocaleString('es-CO') %> × <%= i.cantidad %></p>
              <% } %>
              <p><strong>Fecha:</strong> <%= i.fecha %></p>

              <% if (i.estado === 'activa') { %>
                <button 
                  class="user__btn btn-cancelar"
                  data-id="<%= i._id %>"
                  data-tipo="<%= tipo %>">
                  Cancelar
                </button>
              <% } %>
            </div>
          </div>
        <% }) %>
      <% } else { %>
        <p style="text-align:center;margin:40px auto;">No hay registros en esta sección.</p>
      <% } %>
    </div>
  </main>

  <!-- MODAL -->
  <div id="modalConfirm" class="modal-bg">
    <div class="modal-box">
      <h3>¿Deseas cancelar esta reserva?</h3>
      <p style="margin-top:10px;font-size:14px;color:#555;">
        Esta acción no se puede deshacer.
      </p>

      <div class="modal-btns">
        <button class="btn-aceptar" id="confirmYes">Aceptar</button>
        <button class="btn-cerrar" id="confirmNo">Cancelar</button>
      </div>
    </div>
  </div>

  <!-- SCRIPT -->
  <script>
    // Menú usuario
    (function(){
      const btn=document.getElementById("userMenuBtn");
      const user=btn.closest(".user");
      btn.addEventListener("click",e=>{e.stopPropagation();user.classList.toggle("open");});
      document.addEventListener("click",e=>{if(!user.contains(e.target))user.classList.remove("open");});
    })();


    /* ===========================
       MODAL LÓGICA
    ============================ */
    let cancelId = null;
    let cancelTipo = null;

    const modal = document.getElementById("modalConfirm");
    const yesBtn = document.getElementById("confirmYes");
    const noBtn = document.getElementById("confirmNo");

    document.querySelectorAll('.btn-cancelar').forEach(btn=>{
      btn.addEventListener('click',()=>{
        cancelId = btn.dataset.id;
        cancelTipo = btn.dataset.tipo;
        modal.classList.add("show");
      });
    });

    noBtn.addEventListener("click",()=>{
      modal.classList.remove("show");
    });

    yesBtn.addEventListener("click", async () => {
      modal.classList.remove("show");

      const resp = await fetch("/perfil/cancelar", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ id: cancelId, tipo: cancelTipo })
      });

      const data = await resp.json();

      if (data.ok) {
        window.location.href = "/perfil/reservas?tipo=historial";
      }
    });
  </script>

</body>
</html>
